# Pipeline secundária: reorganização estrutural da pasta Projetos DevOps (execução sob demanda)
# Faz exatamente o que o script local faz: mover pastas para Ano > Cliente > Feature, mesclar Qualiit → Quali It, remover duplicatas em 2020-2023.
# NÃO possui agendamento — rodar SOMENTE quando houver necessidade de reorganizar a pasta principal.
# Variáveis: mesmas da pipeline principal (AZURE_DEVOPS_PAT, SHAREPOINT_*, AZURE_DEVOPS_ORG, AZURE_DEVOPS_PROJECT).
# Ver README.md e docs/CONFIGURAR_PIPELINE.md.

trigger: none

# Sem schedules — apenas disparo manual (Run pipeline).

pool:
  vmImage: "ubuntu-latest"

variables:
  PYTHON_VERSION: "3.10"
  LOG_LEVEL: "INFO"

jobs:
  - job: ReorganizarProjetosDevOps
    timeoutInMinutes: 60
    steps:
      - checkout: self
        displayName: "Checkout do código"
        fetchDepth: 1

      - task: UsePythonVersion@0
        displayName: "Configurar Python $(PYTHON_VERSION)"
        inputs:
          versionSpec: "$(PYTHON_VERSION)"
          addToPath: true

      - script: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
        displayName: "Instalar dependências Python"
        workingDirectory: "$(Build.SourcesDirectory)"

      - script: |
          if [ -z "$(AZURE_DEVOPS_PAT)" ]; then
            echo "##vso[task.logissue type=error]AZURE_DEVOPS_PAT não configurado"
            exit 1
          fi
          if [ -z "$(SHAREPOINT_CLIENT_ID)" ] || [ -z "$(SHAREPOINT_CLIENT_SECRET)" ] || [ -z "$(SHAREPOINT_TENANT_ID)" ]; then
            echo "##vso[task.logissue type=error]Variáveis SharePoint obrigatórias"
            exit 1
          fi
          echo "Variáveis de ambiente validadas"
        displayName: "Validar variáveis"
        env:
          AZURE_DEVOPS_PAT: $(AZURE_DEVOPS_PAT)
          SHAREPOINT_CLIENT_ID: $(SHAREPOINT_CLIENT_ID)
          SHAREPOINT_CLIENT_SECRET: $(SHAREPOINT_CLIENT_SECRET)
          SHAREPOINT_TENANT_ID: $(SHAREPOINT_TENANT_ID)

      - script: |
          cd backend
          python script_estruturar_projetos_devops_once.py
        displayName: "Executar reorganização (Ano > Cliente > Feature; mesclar Qualiit; remover duplicatas 2020-2023)"
        env:
          AZURE_DEVOPS_PAT: $(AZURE_DEVOPS_PAT)
          AZURE_DEVOPS_ORG: $(AZURE_DEVOPS_ORG)
          AZURE_DEVOPS_PROJECT: $(AZURE_DEVOPS_PROJECT)
          SHAREPOINT_CLIENT_ID: $(SHAREPOINT_CLIENT_ID)
          SHAREPOINT_CLIENT_SECRET: $(SHAREPOINT_CLIENT_SECRET)
          SHAREPOINT_TENANT_ID: $(SHAREPOINT_TENANT_ID)
          SHAREPOINT_SITE_URL: $(SHAREPOINT_SITE_URL)
          SHAREPOINT_FOLDER_PATH_BASE: $(SHAREPOINT_FOLDER_PATH_BASE)
          LOG_LEVEL: $(LOG_LEVEL)
        continueOnError: false
