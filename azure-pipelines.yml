# Pipeline de varredura: pastas SharePoint por Feature (FluxoNovasFeatures)
# Gatilhos: SOMENTE execução manual na 1ª vez; depois configure Service Hooks para
#   "Work item created" e "Work item updated" apontando para a API (webhook) para
#   novas Features e anexos adicionados/atualizados.
# Variáveis: AZURE_DEVOPS_PAT, SHAREPOINT_*, AZURE_DEVOPS_ORG, AZURE_DEVOPS_PROJECT (ver docs)

trigger: none
# Sem schedules: após a primeira execução manual, use Service Hooks (Project Settings)
# para disparar a API nos eventos "Work item created" e "Work item updated".

pool:
  vmImage: "ubuntu-latest"

variables:
  PYTHON_VERSION: "3.10"
  LOG_LEVEL: "INFO"

steps:
  - checkout: self
    displayName: "Checkout do código"
    fetchDepth: 1

  - task: UsePythonVersion@0
    displayName: "Configurar Python $(PYTHON_VERSION)"
    inputs:
      versionSpec: "$(PYTHON_VERSION)"
      addToPath: true

  - script: |
      python -m pip install --upgrade pip
      pip install -r backend/requirements.txt
    displayName: "Instalar dependências Python"
    workingDirectory: "$(Build.SourcesDirectory)"

  - script: |
      if [ -z "$(AZURE_DEVOPS_PAT)" ]; then
        echo "##vso[task.logissue type=error]AZURE_DEVOPS_PAT não configurado"
        exit 1
      fi
      if [ -z "$(SHAREPOINT_CLIENT_ID)" ] || [ -z "$(SHAREPOINT_CLIENT_SECRET)" ] || [ -z "$(SHAREPOINT_TENANT_ID)" ]; then
        echo "##vso[task.logissue type=error]Variáveis SharePoint obrigatórias"
        exit 1
      fi
      echo "Variáveis de ambiente validadas"
    displayName: "Validar variáveis"
    env:
      AZURE_DEVOPS_PAT: $(AZURE_DEVOPS_PAT)
      SHAREPOINT_CLIENT_ID: $(SHAREPOINT_CLIENT_ID)
      SHAREPOINT_CLIENT_SECRET: $(SHAREPOINT_CLIENT_SECRET)
      SHAREPOINT_TENANT_ID: $(SHAREPOINT_TENANT_ID)

  - task: Cache@2
    displayName: "Restaurar cache da última execução (last_run)"
    inputs:
      key: "pipeline-lastrun-$(Build.SourceBranch)"
      path: backend/logs

  - script: |
      cd backend
      python pipeline_feature_folders.py
    displayName: "Executar varredura (pastas + link + anexos)"
    env:
      AZURE_DEVOPS_PAT: $(AZURE_DEVOPS_PAT)
      AZURE_DEVOPS_ORG: $(AZURE_DEVOPS_ORG)
      AZURE_DEVOPS_PROJECT: $(AZURE_DEVOPS_PROJECT)
      SHAREPOINT_CLIENT_ID: $(SHAREPOINT_CLIENT_ID)
      SHAREPOINT_CLIENT_SECRET: $(SHAREPOINT_CLIENT_SECRET)
      SHAREPOINT_TENANT_ID: $(SHAREPOINT_TENANT_ID)
      SHAREPOINT_SITE_URL: $(SHAREPOINT_SITE_URL)
      SHAREPOINT_FOLDER_PATH_BASE: $(SHAREPOINT_FOLDER_PATH_BASE)
      LOG_LEVEL: $(LOG_LEVEL)
      PIPELINE_FULL_SCAN: $(PIPELINE_FULL_SCAN)
    continueOnError: false

  - task: PublishBuildArtifacts@1
    displayName: "Publicar logs"
    inputs:
      pathToPublish: "backend/logs"
      artifactName: "logs"
      publishLocation: "Container"
    condition: always()
